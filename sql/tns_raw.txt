create function getPercent(a INT , b varchar (100)) 
returns DECIMAL(10,2)
DETERMINISTIC
BEGIN
DECLARE result DECIMAL(10,2);
  SET result = null;
  select percent into result from sub_discipline where discipline_id = a and name = b;
  RETURN result;
end;


select 
agency_id as ResponsdentId, 
category_name as Industry,
max(if(name = 'Search', value, null)) as 'Search',

max(if(name = 'Display', value, null)) as 'Display',
max(if(name = 'Display', getPercent(id, 'Direct') * value, null)) as 'Display Direct',
max(if(name = 'Display', getPercent(id, 'Ad Network') * value, null)) as 'Display Ad Network',
max(if(name = 'Display', getPercent(id, 'Programmatic') * value, null)) as 'Display Programmatic',

max(if(name = 'Online Video', value, null)) as 'Online Video',
max(if(name = 'Online Video', getPercent(id, 'Direct') * value, null)) as 'Online Video Direct',
max(if(name = 'Online Video', getPercent(id, 'Ad Network') * value, null)) as 'Online Video Ad Network',
max(if(name = 'Online Video', getPercent(id, 'Programmatic') * value, null)) as 'Online Video Programmatic',

max(if(name = 'YouTube Ad', value, null)) as 'YouTube Ad',
max(if(name = 'YouTube Ad', getPercent(id, 'Display Desktop') * value, null)) as 'YouTube Ad Display Desktop',
max(if(name = 'YouTube Ad', getPercent(id, 'Display Mobile') * value, null)) as 'YouTube Ad Display Mobile',
max(if(name = 'YouTube Ad', getPercent(id, 'Video Desktop') * value, null)) as 'YouTube Ad Video Desktop',
max(if(name = 'YouTube Ad', getPercent(id, 'Video Mobile') * value, null)) as 'YouTube Ad Video Mobile',

max(if(name = 'Facebook Ad', value, null)) as 'Facebook Ad',
max(if(name = 'Facebook Ad', getPercent(id, 'Display Desktop') * value, null)) as 'Facebook Ad Display Desktop',
max(if(name = 'Facebook Ad', getPercent(id, 'Display Mobile') * value, null)) as 'Facebook Ad Display Mobile',
max(if(name = 'Facebook Ad', getPercent(id, 'Video Desktop') * value, null)) as 'Facebook Ad Video Desktop',
max(if(name = 'Facebook Ad', getPercent(id, 'Video Mobile') * value, null)) as 'Facebook Ad Video Mobile',

max(if(name = 'Instagram Ad', value, null)) as 'Instagram Ad',
max(if(name = 'Instagram Ad', getPercent(id, 'Display') * value, null)) as 'Instagram Ad Display',
max(if(name = 'Instagram Ad', getPercent(id, 'Video') * value, null)) as 'Instagram Ad Video',

max(if(name = 'Twitter Ad', value, null)) as 'Twitter Ad',
max(if(name = 'LINE', value, null)) as 'LINE',
max(if(name = 'Instant Messaging', value, null)) as 'Instant Messaging',
max(if(name = 'Social', value, null)) as 'Social',
max(if(name = 'Native Ads', value, null)) as 'Native Ads',

max(if(name = 'Creative', value, null)) as 'Creative',
max(if(name = 'Creative', getPercent(id, 'Online Video') * value, null)) as 'Creative Online Video',
max(if(name = 'Creative', getPercent(id, 'Web Banner') * value, null)) as 'Creative Web Banner',
max(if(name = 'Creative', getPercent(id, 'Social Media') * value, null)) as 'Creative Social Media',

max(if(name = 'Others/', value, null)) as 'Others/'
from discipline
where sheet = 1 and agency_id in (select agency_id from log where status = 'finish' and agency_id != 'T052')
group by agency_id, category_name 
order by agency_id, category_name 



select * from sub_discipline where discipline_id = 14742
select * from sub_discipline where  name = 'Direct'
(select percent from sub_discipline where discipline_id = 14262 and name = 'Programmatic')



select agency_id as ResponsdentId,
max(if(qno = '1', answer, null)) as 'Q1',
max(if(qno = '2', answer, null)) as 'Q2',
max(if(qno = '3', answer, null)) as 'Q3',
max(if(qno = '4.1', answer, null)) as 'Q4.1',
max(if(qno = '4.2', answer, null)) as 'Q4.2',
max(if(qno = '5', answer, null)) as 'Q5',
max(if(qno = '6', answer, null)) as 'Q6',
max(if(qno = '7', answer, null)) as 'Q7',
max(if(qno = '8', answer, null)) as 'Q8',
max(if(qno = '9', answer, null)) as 'Q9',
max(if(qno = '10.1', answer, null)) as 'Q10.1',
max(if(qno = '10.2', answer, null)) as 'Q10.2'
from answer 
where agency_id in (select agency_id from log where status = 'finish' and agency_id != 'T052')
group by agency_id
order by agency_id
